@model CDMIS.ViewModels.UserViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Title = "用户维护";
}
<link href="../../Content/jquery.dataTables.css" rel="stylesheet" type="text/css" />
<link href="../../Content/simpleModal.css" rel="stylesheet" type="text/css" />
<link rel="Stylesheet" href="../../Content/chosen.css" />
<script type="text/javascript" src="../../Scripts/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="../../Scripts/MicrosoftAjax.js"></script>
<script type="text/javascript" src="../../Scripts/MicrosoftMvcAjax.js"></script>
<script type="text/javascript" src="../../Scripts/jquery.unobtrusive-ajax.min.js"></script>
<script type="text/javascript" src="../../Scripts/jquery.dataTables.js"></script>
<script type="text/javascript" src="../../Scripts/chosen.jquery.min.js"></script>
<script type="text/javascript" src="../../Scripts/jquery.simplemodal.1.4.4.min.js"></script>
<script type="text/javascript" src="../../Scripts/My97DatePicker/WdatePicker.js"></script>
<style type="text/css">
    #alert-container
    {
        height: 120px;
        width: 300px;
    }
     #simplemodal-container 
     {
         height:450px; 
         width:400px;
     }
     #reminder-container
     {
         height:600px; 
         width:500px;
     }
</style>
<div width="100%" style="border: 0;">
    @using (Ajax.BeginForm("UserPartialView", "Management", null,
                            new AjaxOptions
                            {
                                UpdateTargetId = "UserSearchContainer",
                                HttpMethod = "Post",
                                OnSuccess = " ",
                            }))
    { 
                            
                            
@*<div style="height:50px; visibility: hidden"></div>*@
        <div class="form-horizontal" role="form">
            <div class="form-group">
                <div class="col-sm-offset-10 col-sm-2">
                    <input type="button" class="btn btn-primary" id="NewRole" value="新建用户" style="font-size: 16px;float:right;" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-1 control-label">
                    用户类别</label>
                <div class="col-sm-3"> 
                    @Html.DropDownListFor(m => m.Patient.Class, Model.UserClassList(), new { id = "SearchRole", @onchange = "onSearch()", style = "font-size:18px", @class = "form-control" })
                </div>
                <label class="col-sm-1 control-label">
                    手机号</label>
                <div class="col-sm-3">
                    @Html.TextBoxFor(model => model.SearchPhoneNo, new { id = "SearchPhoneNo", @onkeydown = "onSearch()", @class = "form-control" })
                </div>
                <label class="col-sm-1 control-label">
                    姓名</label>
                <div class="col-sm-3">
                    @Html.TextBoxFor(model => model.SearchUserName, new { id = "SearchUserName", @onkeydown = "onSearch()", @class = "form-control" })
                </div>
            </div>
        </div>
                            

                               
                            
    }

    <fieldset style="width: 100%; height: 700px">
        <legend>用户信息列表</legend>
        <div id="UserSearchContainer">
            <table width="100%" id="UserListDT" class="display">
                <thead class="fixedHeader">
                    <tr>
                        <th width="10%">
                            用户ID
                        </th>
                        <th width="10%">
                            姓名
                        </th>
                        <th width="10%">
                            密码
                        </th>
                        <th  style="display: none;">
                            用户类别编码
                        </th>
                        <th width="10%">
                            用户类别
                        </th>
                        <th width="10%">
                            密码有效期
                        </th>
                        <th width="10%">
                            手机号
                        </th>
                        <th width="20%">
                            操作
                        </th>
                    </tr>
                </thead>
                <tbody id="TableBody" class="scrollContent">
                    @if (Model.RowCount > 0)
                    {
                        foreach (var item in Model.UserList)
                        {
                        <tr class="normalRow">
                            <td width="10%">@item.UserId
                            </td>
                            <td width="10%">@item.UserName
                            </td>
                            <td width="10%">@item.Password
                            </td>
                            <td width="10%" style="display: none;">@item.Class
                            </td>
                            <td width="10%">@item.ClassName
                            </td>
                            <td width="10%">@item.EndDate
                            </td>
                            <td width="10%">@item.PhoneNo
                            </td>
                            <td width="20%">
                                @if(@item.Class=="Administrator")
                                {
                                    <input type="button" value="新建角色" class="btn btn-primary newroleBtn" disabled="disabled"/>
                                }
                                else
                                {
                                    <input type="button" value="新建角色" class="btn btn-primary newroleBtn" />
                                
                                }
                                |
                                <input type="button" value="编辑" class="btn btn-primary editBtn" />
                                |
                                <input type="button" value="删除" class="btn btn-primary deleteBtn" />
                            </td>
                        </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </fieldset>
@*    <div style="width: 100%; height: 500px;">
        @Html.ValidationSummary(true, "User Information update was unsuccessful. Please correct the errors and try again.")
    </div>*@
</div>
<div id="setUserInfo" >
    <div class="modalHeader">
        <span>用户信息设定</span></div>
    <div class="modalContent">
        <fieldset> 
            <legend>用户信息设定</legend>
            <div class="form-group" id="PhoneNo1Div">
                <label class="col-sm-4 control-label">
                    *手机号</label>
                <div class="col-sm-8">
                    @*@Html.TextBoxFor(model => model.Patient.PhoneNo, new { id = "PhoneNo1", name = "PhoneNo1", @class = "form-control" })*@

                    <input  id = "PhoneNo1", name = "PhoneNo1", class = "form-control" ,value=""/> 
                    <p id="phoneWrn1" style="font-size: 16px; color: #FF0000; font-weight: bold;display: none"></p>
                </div>
            </div>

            <div class="form-group" id="New" style="display: none">
                <label class="col-sm-4 control-label">
                    用户类别</label>
                <div class="col-sm-8">
                    @Html.DropDownListFor(m => m.Patient.Class, Model.RoleClassList(), new { id = "newUserClass", @onchange = "New()", style = "font-size:18px", @class = "form-control" })
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-4 control-label">
                    *用户ID</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(m => m.Patient.UserId, new { @readonly = "true", id = "txtUserId", @class = "form-control" })
                    <p id="UIdWrn" style="font-size: 16px; color: #FF0000; font-weight: bold;display: none"></p>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">
                    用户名</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(m => m.Patient.UserName, new { id = "txtUserName", @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">
                    用户类别</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(m => m.Patient.ClassName, new { @readonly = "true", id = "userClassList", @class = "form-control" })
                </div>
            </div>
            <div class="form-group" style="display: none">
                <label class="col-sm-4 control-label">
                    用户类别代码</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(m => m.Patient.Class, new { @readonly = "true", id = "userClassCode", @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">
                    密码</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(m => m.Patient.Password, new { id = "txtPassword", @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">
                    密码有效期</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(model => model.Patient.EndDate, new { id = "EndDate", @class = "form-control", @onclick = "WdatePicker({startDate:'1991-02-14',dateFmt:'yyyy-MM-dd'})" })
                </div>
            </div>
            <div class="form-group" id="PhoneNoDiv">
                <label class="col-sm-4 control-label">
                    *手机号</label>
                <div class="col-sm-8">
                    @*@Html.TextBoxFor(model => model.Patient.PhoneNo, new { id = "PhoneNo", name="PhoneNo", @class = "form-control" })*@
                    <input  id = "PhoneNo", name = "PhoneNo", class = "form-control", value=""/> 
                    <p id="phoneWrn" style="font-size: 16px; color: #FF0000; font-weight: bold;display: none"></p>
                </div>
            </div>
            
            <div id="CoachAndDoc" style="display: none">
                <div class="form-group">
                    <label class="col-sm-4 control-label">
                        工作单位</label>
                    <div class="col-sm-8">
                        @Html.DropDownListFor(m => m.UnitName, Model.GetHospitalList(), new { id = "UnitName", @class = "form-control" })
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">
                        科室</label>
                    <div class="col-sm-8">
                        @Html.DropDownListFor(m => m.Dept, Model.GetDeptList(), new { id = "Dept", @class = "form-control" })
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">
                        职务</label>
                    <div class="col-sm-8">
                        @Html.TextBoxFor(m => m.JobTitle, new { id = "JobTitle", @class = "form-control" })
                    </div>
                </div>
            </div>
            <div id="DocMod" class="form-group">
                <label class="col-sm-4 control-label">
                    模块</label>
                <div class="col-sm-8">
                    @Html.ListBoxFor(m => m.models, Model.ModelsTypeList, new { id = "Modules", @class = "form-control chzn-select", multiple = "multiple", style = "font-size:34px;width:100%;height:34px;" })
                </div>
            </div>
            <div class="form-group">
                 <div class="col-sm-offset-3 col-sm-3">
                    <input type="button" class="btn btn-primary" id="Save" value="保存" style="font-size: 16px;
                        margin-top: 30px" />
                </div>
                <div class="col-sm-3">
                    <input type="button" class="btn btn-primary" id="Cancel" value="取消" style="font-size: 16px;
                        margin-top: 30px" />
                </div>
                <div class="col-sm-3">
                </div>
            </div>
        </fieldset>
    </div>
</div>
<div id="addDataDiv" style="display: none;">
    <div class="modalHeader">
        <span>信息错误！</span></div>
    <div class="modalContent">
        <center>
            <p id="addDataP">
            </p>
            <input type="button" class="btn btn-default simplemodal-close" value="确定" />
        </center>
    </div>
</div>
<div id="success" style="display: none;">
    <div class="modalHeader">
        <span></span>
    </div>
    <div class="modalContent">
        <center>
            <p id="successD">
            </p>
            <input type="button" class="btn btn-default simplemodal-close" value="确定" />
        </center>
    </div>
</div>
<script type="text/javascript">
    var newflag = 0;
    function hide() {
        var target = document.getElementById("UserListDT");
        target.style.display = "none";
    }
    function success() {
        var target = document.getElementById("UserListDT");
        target.style.display = "block";
    }

    $(document).ready(function () {
        $("#menu a").attr("id", ""); //Reset id's 
        $("#menu li:eq(0) a").attr("id", "current");

        var table = $('#UserListDT').DataTable({
            "oLanguage": {//语言国际化
                "sUrl": "/Content/jquery.dataTable.cn.txt"
            },
            "bAutoWidth": false,
            "bPaginate": false,  //是否分页。
            "sScrollX": "100%",
            "sScrollY": "500px",
            "order": [3, 'desc'],   //排序
            "bFilter": false

        });

        //$(".chosen").trigger('liszt:updated');
        $('.chzn-select').chosen({
            placeholder_text_multiple: " "
        });

        //$(".chosen").chosen().change();
        //        $(".chosen").trigger('chosen:updated');

        //   $('#DocMod').attr('style', "display:none");
        $('#DocMod').css("display", "none");
        $('#setUserInfo').css("display", "none");

        $.ajax({                                                //初始化日期控件为系统当前时间+1年（默认密码有效期为一年）
            url: "/Management/GetDefaultEndTime",
            type: "GET",
            dataType: "json",
            async: false,
            data: {},
            success: function (res) {
                document.getElementById("EndDate").value = res.toString();
            }
        });

    });

    //编辑按钮触发
    $(".editBtn").click(function () {
        newflag = 0;
        $('#PhoneNoDiv').css("display", "block");
        $('#PhoneNo1Div').css("display", "none");

        $('#New').css("display", "none");
        $('#phoneWrn').css("display", "none");
        $('#UIdWrn').css("display", "none");
        
        trSeq = $(this).parent().parent().parent().find("tr").index($(this).parent().parent());
        var txtUserId = $("#TableBody tr:eq(" + trSeq + ") td:eq(0)").text().trim();

        document.getElementById("txtUserId").value = txtUserId;
        var userId = txtUserId;
        var txtUserName = $("#TableBody tr:eq(" + trSeq + ") td:eq(1)").text().trim();
        document.getElementById("txtUserName").value = txtUserName;
        var txtPassword = $("#TableBody tr:eq(" + trSeq + ") td:eq(2)").text().trim();
        document.getElementById("txtPassword").value = txtPassword;
        var userClassCode = $("#TableBody tr:eq(" + trSeq + ") td:eq(3)").text().trim();

        var userClass = $("#TableBody tr:eq(" + trSeq + ") td:eq(4)").text().trim();
        document.getElementById("userClassList").value = userClass;
        document.getElementById("userClassCode").value = userClassCode;
        var EndDate = $("#TableBody tr:eq(" + trSeq + ") td:eq(5)").text().trim();

        document.getElementById("EndDate").value = EndDate;
        $("#PhoneNo").val(GetPhoneNo(userId));

        if (userClassCode == 'HealthCoach') {
            $('#CoachAndDoc').css("display", "block");
            $('#DocMod').css("display", "none");
            GetDoctorDetailInfo(userId, userClassCode);

            $('#setUserInfo').modal({
                closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
                containerId: 'reminder-container',
                overlayClose: true     //点击蒙层关闭窗口
            });

        }
        else if (userClassCode == 'Doctor') {
            $('#CoachAndDoc').css("display", "block");
            $('#DocMod').css("display", "block");
            //$("#Modules").removeClass("chosen");
            //          $("#Modules").trigger("liszt:updated");
            //          $("#Modules").chosen();
            GetDoctorDetailInfo(userId, userClassCode);

            $('#setUserInfo').modal({
                closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
                containerId: 'reminder-container',
                overlayClose: true     //点击蒙层关闭窗口
            });

            $("#Modules").trigger("liszt:updated");
            $("#Modules").chosen();

        }
        else {
            
            $('#CoachAndDoc').css("display", "none");
            $('#DocMod').css("display", "none");
            $('#setUserInfo').modal({
                closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
                containerId: 'simplemodal-container',
                overlayClose: true     //点击蒙层关闭窗口
            });
        }
    });



    //删除按钮触发
    $(".deleteBtn").click(function () {
        trSeq = $(this).parent().parent().parent().find("tr").index($(this).parent().parent());
        var Code = $("#TableBody tr:eq(" + trSeq + ") td:eq(0)").text().trim();
        DeleteData(Code);
    });


    function trim(str) {  //删除左右两端的空格
        return str.replace(/(^\s*)|(\s*$)/g, "");
    }
    function refresh(e) {
        if (e.toString() == "OK") {
            alert("保存成功！");
        }
        else {
            alert("保存失败！");
        }
        window.location.href = window.location.href;
    }
    $("#NewRole").on('click', function () {
        $('#PhoneNo1Div').css("display", "block");
        $('#PhoneNoDiv').css("display", "none");

        $('#phoneWrn1').css("display", "none");
        $('#UIdWrn').css("display", "none");

        newflag = 1;
        var defaultEndTime;
        $.ajax({                                                //初始化日期控件为系统当前时间+1年（默认密码有效期为一年）
            url: "/Management/GetDefaultEndTime",
            type: "GET",
            dataType: "json",
            async: false,
            data: {},
            success: function (res) {
                defaultEndTime = res.toString();
            }
        });

        $('#New').css("display", "block");
        $('#CoachAndDoc').css("display", "none");
        $('#DocMod').css("display", "none");
        document.getElementById("txtUserId").value = "";
        document.getElementById("txtUserName").value = "";
        document.getElementById("txtPassword").value = "";
        $("#userClassList").val("");
        $("#userClassCode").val("");
      
        document.getElementById("EndDate").value = defaultEndTime;
        document.getElementById("PhoneNo").value = "";

        $('#setUserInfo').modal({
            closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
            containerId: 'reminder-container',
            overlayClose: true     //点击蒙层关闭窗口
        });
    });

    function New() {
        //$("#newUserClass").val("0");
        var UId = "";
        $('#phoneWrn1').css("display", "none");
        var PhoneNo1 = document.getElementById("PhoneNo1").value;
        if (PhoneNo1 == undefined) {PhoneNo1 = ""; }
        if (PhoneNo1.match(/^\d{11}$/) == null) {
            //alert("请输入11位手机号");
            event.preventDefault();
            var Text = "请输入11位手机号！";

            $('#phoneWrn1').html(Text);
            $('#phoneWrn1').css("display", "block");


        }
        else {
            var clslist = document.getElementById("newUserClass");
            var userClass = clslist.options[clslist.selectedIndex].text;
            var userClassCode = clslist.options[clslist.selectedIndex].value;
            var defaultEndTime;

            //此处判断该手机号有无用户Id
            $.ajax({
                url: "/Management/GetUIdByPhoneNo",
                type: "GET",
                dataType: "json",
                async: false,
                data: { PhoneNo: PhoneNo1 },
                success: function (res) {
                    UId = res.toString();
                }
            });


            $.ajax({                                                //初始化日期控件为系统当前时间+1年（默认密码有效期为一年）
                url: "/Management/GetDefaultEndTime",
                type: "GET",
                dataType: "json",
                async: false,
                data: {},
                success: function (res) {
                    defaultEndTime = res.toString();
                }
            });

            if (userClassCode == '0') {
                document.getElementById("txtUserId").value = "";
                document.getElementById("txtUserName").value = "";
                document.getElementById("txtPassword").value = "";
                $("#userClassList").val("");
                $("#userClassCode").val("");
                document.getElementById("EndDate").value = defaultEndTime;

            }

            else 
            {
                if (UId == "") {
                    $.ajax({
                        url: "/Management/GetRoleNo",
                        type: "GET",
                        dataType: "json",
                        async: false,
                        data: { userClass: userClassCode },
                        success: function (res) {
                            var userId = res;
                            if (userId != "") 
                            {
                                document.getElementById("txtUserId").value = userId;
                                document.getElementById("txtUserName").value = "";
                                document.getElementById("txtPassword").value = "";
                                $("#userClassList").val(userClass);
                                $("#userClassCode").val(userClassCode);
                                document.getElementById("EndDate").value = defaultEndTime;
                                document.getElementById("PhoneNo").value = "";

                                if (userClassCode == 'HealthCoach') {
                                    $('#CoachAndDoc').css("display", "block");
                                    $('#DocMod').css("display", "none");
                                    GetDoctorDetailInfo(userId, userClassCode);


                                }
                                else if (userClassCode == 'Doctor') {
                                    $('#CoachAndDoc').css("display", "block");
                                    $('#DocMod').css("display", "block");
                                    //                        $("#Modules").chosen();
                                    //                        $("#Modules").trigger("chosen:updated");
                                    GetDoctorDetailInfo(userId, userClassCode);


                                    $("#Modules").trigger("liszt:updated");
                                    $("#Modules").chosen();

                                }
                                else {
                                    $('#CoachAndDoc').css("display", "none");
                                    $('#DocMod').css("display", "none");

                                }
                            }

                        }
                    });
                }
                else 
                {
                    document.getElementById("txtUserId").value = UId;
                    document.getElementById("txtUserName").value = "";
                    document.getElementById("txtPassword").value = "";
                    $("#userClassList").val(userClass);
                    $("#userClassCode").val(userClassCode);
                    document.getElementById("EndDate").value = defaultEndTime;
                    document.getElementById("PhoneNo").value = "";

                    if (userClassCode == 'HealthCoach') {
                        $('#CoachAndDoc').css("display", "block");
                        $('#DocMod').css("display", "none");
                        GetDoctorDetailInfo(UId, userClassCode);


                    }
                    else if (userClassCode == 'Doctor') {
                        $('#CoachAndDoc').css("display", "block");
                        $('#DocMod').css("display", "block");
                        //                        $("#Modules").chosen();
                        //                        $("#Modules").trigger("chosen:updated");
                        GetDoctorDetailInfo(UId, userClassCode);


                        $("#Modules").trigger("liszt:updated");
                        $("#Modules").chosen();

                    }
                    else {
                        $('#CoachAndDoc').css("display", "none");
                        $('#DocMod').css("display", "none");

                    }
                 
                }
            }
        }
    }

    $("#Cancel").on('click', function () {
        $('#phoneWrn').css("display", "none");
        $('#phoneWrn1').css("display", "none");
        $('#UIdWrn').css("display", "none");

        var defaultEndTime;
        $.ajax({                                                //初始化日期控件为系统当前时间+1年（默认密码有效期为一年）
            url: "/Management/GetDefaultEndTime",
            type: "GET",
            dataType: "json",
            async: false,
            data: {},
            success: function (res) {
                defaultEndTime = res.toString();
            }
        });

        document.getElementById("txtUserId").value = "";
        document.getElementById("txtUserName").value = "";
        document.getElementById("txtPassword").value = "";
        $("#newUserClass").val("0");
        $("#userClassList").val("");
        $("#userClassCode").val("");
        document.getElementById("EndDate").value = defaultEndTime;
        document.getElementById("PhoneNo").value = "";
        document.getElementById("PhoneNo1").value = "";

        document.getElementById("UnitName").value = "";
        document.getElementById("Dept").value = "";
        document.getElementById("JobTitle").value = "";

        $('#txtUserId').attr('disabled', "disabled");
        $('#txtUserId').removeAttr('disabled');
//        window.location.href = window.location.href;
    });

    $("#Save").bind('click', function (event) {

        $('#phoneWrn1').css("display", "none");
        $('#phoneWrn').css("display", "none");
        if (newflag == 1) {
            var PhoneNo1 = document.getElementById("PhoneNo1").value;
            if (PhoneNo1 == undefined) { PhoneNo1 = ""; }
            if (PhoneNo1.match(/^\d{11}$/) == null) {
                //alert("请输入11位手机号");
                event.preventDefault();
                var Text = "请输入11位手机号！";

                $('#phoneWrn1').html(Text);
                $('#phoneWrn1').css("display", "block");


            }
        }
        else 
        {
            var PhoneNo = document.getElementById("PhoneNo").value;
            if (PhoneNo == undefined) { PhoneNo = ""; }
            if (PhoneNo.match(/^\d{11}$/) == null) {
                //alert("请输入11位手机号");
                event.preventDefault();
                var Text = "请输入11位手机号！";

                $('#phoneWrn').html(Text);
                $('#phoneWrn').css("display", "block");


            }
        }
        var SetMstUserFlag = false;
        var userId = document.getElementById("txtUserId").value;

        if (userId == "") {

            event.preventDefault();
            var Text = "请选择一个用户！";
            $('#UIdWrn').html(Text);
            $('#UIdWrn').css("display", "block");

        }
        else {
            var UserName = document.getElementById("txtUserName").value;
            var Password = document.getElementById("txtPassword").value;
            var userClass = document.getElementById("userClassList").value;
            var userClassCode = document.getElementById("userClassCode").value;
            var EndDate = document.getElementById("EndDate").value;
            var PhoneNo = document.getElementById("PhoneNo").value;
            if (PhoneNo.match(/^\d{11}$/) == null) {
                //alert("请输入11位手机号");
                event.preventDefault();
                var Text = "请输入11位手机号！";

                $('#phoneWrn').html(Text);
                $('#phoneWrn').css("display", "block");


            }
            else {

                if (userId != "") {
                    $.ajax({
                        url: "/Management/setCmMstUser",
                        type: "GET",
                        dataType: "json",
                        async: false,
                        data: { UserId: userId, UserName: UserName, Password: Password, EndDate: EndDate, PhoneNo: PhoneNo, userClassCode: userClassCode, NewFlag: newflag },
                        success: function (res) {
                            SetMstUserFlag = res;
                            //                alert(res);
                        }
                    });
                }
                if (SetMstUserFlag == 1) {
                    if ((userClassCode == "Administrator") || (userClassCode == "Patient")) {
                        location.reload();
                    }
                    else {
                        var clslist = document.getElementById("UnitName");
                        var UnitName = clslist.options[clslist.selectedIndex].value;
                        var clslist = document.getElementById("Dept");
                        var Dept = clslist.options[clslist.selectedIndex].value;
                        var JobTitle = document.getElementById("JobTitle").value;

                        //alert(PhoneNo);

                        //获取多选框内容
                        var strlist = document.getElementById("Modules"); //获取Listbox 
                        var str = "";
                        //遍历Listbox，取得选中项的值 
                        if (strlist.options.length > 0) {
                            for (var i = 0; i < strlist.options.length; i++) {
                                if (strlist.options[i].selected == true) {
                                    var j = strlist.options[i].value;
                                    str += j + ","; //把Value值串起来
                                }
                            }
                            var strValue = str.replace(/,$/, ""); //去掉最后一个逗号 

                        }
                        else {
                            strValue = "";
                            alert("No Item in Listbox");
                        }

                        setDocDetailInfo(userId, userClassCode, UnitName, Dept, JobTitle, strValue);
                        //                    event.preventDefault();
                        //                    var Text = "保存成功！";
                        //                    $('#successD').html(Text);
                        //                    $('#success').modal({
                        //                        closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
                        //                        containerId: 'alert-container',
                        //                        overlayClose: true     //点击蒙层关闭窗口
                        //                    });
                        location.reload();
                    }

                }
            }
        }
    });

    function onSearch() {//js函数开始
        setTimeout(function () {//因为是即时查询，需要用setTimeout进行延迟，让值写入到input内，再读取  
            var UserList = document.getElementById('UserListDT'); //获取table的id标识  
            var searchRole = $("#SearchRole").val();
            var SearchPhoneNo = $("#SearchPhoneNo").val();
            var searchUserName = $("#SearchUserName").val();
            var searchText1;
            var searchText2;
            var searchText3;

            var rowsLength = UserList.rows.length; //表格总共有多少行  
            if (searchRole == "") {
                if (SearchPhoneNo == "") {
                    for (var i = 1; i < rowsLength; i++) {//按表的行数进行循环，本例第一行是标题，所以i=1，从第二行开始筛选（从0数起）   
                        searchText3 = UserList.rows[i].cells[1].innerHTML; //取得table行，列的值  
                        if (searchText3.match(searchUserName)) {//用match函数进行筛选，如果input的值，即变量 key的值为空，返回的是ture，  
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
                else if (searchUserName == "") {
                    for (var i = 1; i < rowsLength; i++) {
                        searchText2 = UserList.rows[i].cells[6].innerHTML; //取得table行，列的值
                        if (searchText2.match(SearchPhoneNo)) {
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
                else {
                    for (var i = 1; i < rowsLength; i++) {
                        searchText2 = UserList.rows[i].cells[6].innerHTML;
                        searchText3 = UserList.rows[i].cells[1].innerHTML;
                        if (searchText2.match(SearchPhoneNo) && searchText3.match(searchUserName)) {
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
            }
            else {
                if (SearchPhoneNo == "") {
                    for (var i = 1; i < rowsLength; i++) {
                        searchText1 = UserList.rows[i].cells[3].innerHTML;
                        searchText3 = UserList.rows[i].cells[1].innerHTML;
                        if (searchText1.match(searchRole) && searchText3.match(searchUserName)) {
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
                else if (searchUserName == "") {
                    for (var i = 1; i < rowsLength; i++) {
                        searchText1 = UserList.rows[i].cells[3].innerHTML;
                        searchText2 = UserList.rows[i].cells[6].innerHTML;
                        if (searchText1.match(searchRole) && searchText2.match(SearchPhoneNo)) {
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
                else {
                    for (var i = 1; i < rowsLength; i++) {
                        searchText1 = UserList.rows[i].cells[3].innerHTML;
                        searchText2 = UserList.rows[i].cells[6].innerHTML;
                        searchText3 = UserList.rows[i].cells[1].innerHTML;
                        if (searchText1.match(searchRole) && searchText2.match(SearchPhoneNo) && searchText3.match(searchUserName)) {
                            UserList.rows[i].style.display = ''; //显示行操作，  
                        } else {
                            UserList.rows[i].style.display = 'none'; //隐藏行操作  
                        }
                    }
                }
            }
        }, 200);              //200为延时时间  
    }

    function GetPhoneNo(userId) {

        var PhnoeNo = "";
        $.ajax({
            url: "/Management/GetPhoneNo",
            type: "GET",
            dataType: "json",
            async: false,
            data: { UserId: userId },
            success: function (res) {
                //alert(1);
                if (res == null) {
                    //                    PhnoeNo = "未填";
                    PhnoeNo = "";
                }
                else {
                    //alert(res);
                    PhnoeNo = res.toString();
                }
                //document.getElementById("PhnoeNo").value = res.toString();
            }
        });
        //alert(PhnoeNo);
        return PhnoeNo
    }



    function GetDoctorDetailInfo(userId, userClassCode) {
        $.ajax({
            url: "/Management/GetDoctorDetailInfo",
            type: "GET",
            dataType: "json",
            async: false,
            data: { UserId: userId, userClassCode: userClassCode },
            success: function (res) {
                var UnitName = res.split("_")[0];
                var Dept = res.split("_")[1];
                var JobTitle = res.split("_")[2];
                document.getElementById("UnitName").value = UnitName;
                document.getElementById("Dept").value = Dept;
                document.getElementById("JobTitle").value = JobTitle;
                if (userClassCode == "Doctor") {
                    var len = res.split("_").length - 3;
                    var m = [];
                    var Module = "";
                    for (i = 0; i < len; i++) {
                        Module = res.split("_")[3 + i];
                        m.push(Module);
                    }
                    $("#Modules").val(m);
                    $("#Modules").trigger("chosen:updated");

                    //遍历Listbox，取得选中项的值 



                }
            }
        });
    }

    function setDocDetailInfo(userId, userClassCode, UnitName, Dept, JobTitle, Modules) {

        $.ajax({
            url: "/Management/setDocDetailInfo",
            type: "GET",
            dataType: "json",
            async: false,
            data: { UserId: userId, userClassCode: userClassCode, UnitName: UnitName, Dept: Dept, JobTitle: JobTitle, Modules: Modules },
            success: function (res) {
                if (res == true) {
                    //alert("setDocDetailInfo->success");

                }

            }
        });
    }


</script>
